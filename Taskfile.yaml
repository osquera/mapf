version: '3'

vars:
  FRONTEND_DIR: ./frontend
  SOLVERS_DIR: ./solvers
  BACKEND_DIR: ./backend

tasks:
  # ============ Development ============
  default:
    desc: Show available tasks
    cmds:
      - task --list

  dev:
    desc: Start frontend dev server
    dir: '{{.FRONTEND_DIR}}'
    deps: [prepare:maps]
    cmds:
      - npm run dev

  dev:backend:
    desc: Start backend dev server
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - cargo run

  dev:fullstack:
    desc: Start both frontend and backend (parallel)
    cmds:
      - task: dev:backend &
      - task: dev

  # ============ Testing ============
  test:
    desc: Run all tests (Rust + Frontend)
    cmds:
      - task: test:rust
      - task: test:frontend

  test:rust:
    desc: Run Rust tests
    cmds:
      - cargo test --workspace

  test:frontend:
    desc: Run all frontend tests (unit + e2e)
    cmds:
      - task: test:unit
      - task: test:e2e

  test:unit:
    desc: Run frontend unit tests (Vitest)
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npm run test:unit

  test:unit:watch:
    desc: Run frontend unit tests in watch mode
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npm run test:unit -- --watch

  test:e2e:
    desc: Run frontend E2E tests (Playwright)
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npx playwright test

  test:e2e:ui:
    desc: Run E2E tests with Playwright UI
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npx playwright test --ui

  test:e2e:debug:
    desc: Run E2E tests in debug mode
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npx playwright test --debug

  # ============ Type Checking & Linting ============
  check:
    desc: Run all checks (types, lint)
    cmds:
      - task: check:types
      - task: check:rust

  check:types:
    desc: Check TypeScript/Svelte types
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npx svelte-check --tsconfig ./tsconfig.json

  check:rust:
    desc: Check Rust code
    cmds:
      - cargo check --workspace
      - cargo clippy --workspace

  # ============ Building ============
  
  # 1. Main Build Task (For Local Dev / Full Stack)
  build:
    desc: Build EVERYTHING (WASM + Frontend + Backend)
    deps:
      - task: build:wasm
      - task: build:frontend
      - task: build:backend

  # 2. Cloudflare/Static Build Task (No Backend)
  build:static:
    desc: Build only Static Assets (WASM + Frontend) - Use this on Cloudflare!
    cmds:
      - task: build:wasm
      - task: build:frontend

  build:backend:
    desc: Build backend for production
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - cargo build --release

  build:wasm:
    desc: Build WASM solver
    dir: '{{.SOLVERS_DIR}}/mapf-astar'
    cmds:
      - wasm-pack build --target web --out-dir ../../frontend/src/lib/wasm/mapf-astar
      # Ensure static/wasm directory exists
      - cmd: mkdir -p ../../frontend/static/wasm/
        platforms: [linux, darwin]
      - cmd: powershell -Command "New-Item -ItemType Directory -Path '../../frontend/static/wasm/' -Force | Out-Null"
        platforms: [windows]
      # Copy to static for runtime loading
      - cmd: cp ../../frontend/src/lib/wasm/mapf-astar/mapf_astar_bg.wasm ../../frontend/static/wasm/
        platforms: [linux, darwin]
      - cmd: powershell -Command "Copy-Item '../../frontend/src/lib/wasm/mapf-astar/mapf_astar_bg.wasm' -Destination '../../frontend/static/wasm/'"
        platforms: [windows]
      - cmd: cp ../../frontend/src/lib/wasm/mapf-astar/mapf_astar.js ../../frontend/static/wasm/
        platforms: [linux, darwin]
      - cmd: powershell -Command "Copy-Item '../../frontend/src/lib/wasm/mapf-astar/mapf_astar.js' -Destination '../../frontend/static/wasm/'"
        platforms: [windows]

  build:frontend:
    desc: Build frontend for production
    dir: '{{.FRONTEND_DIR}}'
    deps: [prepare:maps]
    cmds:
      - npm ci
      - npm run build

  # FIXED: Rejoined the split command line here
  prepare:maps:
    desc: Copy maps to static folder and generate index
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - node scripts/prepare-maps.js
      - task: setup:backend

  # FIXED: Removed the stray "aps.js" from the echo command
  setup:backend:
    desc: Setup backend environment
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - cmd: cp .env.example .env
        platforms: [linux, darwin]
        ignore_error: true
      - cmd: if not exist .env copy .env.example .env
        platforms: [windows]
        ignore_error: true
      - echo "Backend setup complete. Edit backend/.env with your database credentials."

  # ============ Setup ============
  setup:
    desc: Install all dependencies
    cmds:
      - task: setup:frontend
      - task: setup:playwright

  setup:frontend:
    desc: Install frontend npm dependencies
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npm install

  setup:playwright:
    desc: Install Playwright browsers
    dir: '{{.FRONTEND_DIR}}'
    cmds:
      - npx playwright install chromium

  # ============ Database ============
  db:migrate:
    desc: Run database migrations
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - cargo sqlx migrate run

  db:create:
    desc: Create database
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - cargo sqlx database create

  # ============ Docker/Deployment ============
  docker:build:
    desc: Build backend Docker image
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - docker build -t mapf-server:latest .

  docker:run:
    desc: Run backend with docker-compose
    dir: '{{.BACKEND_DIR}}'
    cmds:
      - docker-compose up -d
      - cargo clean
      - cmd: rm -rf {{.FRONTEND_DIR}}/build {{.FRONTEND_DIR}}/.svelte-kit
        platforms: [linux, darwin]
      - cmd: if exist {{.FRONTEND_DIR}}\build rmdir /s /q {{.FRONTEND_DIR}}\build
        platforms: [windows]

  # ============ CI ============
  ci:
    desc: Run CI pipeline locally
    cmds:
      - task: check
      - task: test
      - task: build